name: Manual Packager

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to package (must exist on main)
        required: true

env:
  BLOCH_VERSION: ${{ inputs.tag }}

jobs:
  package:
    env:
      VCPKG_ROOT: ${{ github.workspace }}/.vcpkg
      VCPKG_FORCE_SYSTEM_BINARIES: 1
      VCPKG_DOWNLOADS: ${{ github.workspace }}/.vcpkg_downloads
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/.vcpkg_cache
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            os_name: Linux
            arch: X64
            cpack_generator: TGZ
            artifact_ext: tar.gz
          - runner: macos-15-intel
            os_name: macOS
            arch: X64
            cpack_generator: TGZ
            artifact_ext: tar.gz
          - runner: macos-latest
            os_name: macOS
            arch: ARM64
            cpack_generator: TGZ
            artifact_ext: tar.gz
          - runner: windows-latest
            os_name: Windows
            arch: X64
            cpack_generator: ZIP
            artifact_ext: zip
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ inputs.tag }}

      - name: Verify tag is on main
        shell: bash
        run: |
          git fetch --depth=1 origin main
          if ! git merge-base --is-ancestor "${{ inputs.tag }}" origin/main; then
            echo "Tag ${{ inputs.tag }} is not reachable from origin/main." >&2
            exit 1
          fi

      - name: Restore vcpkg caches (Windows)
        if: matrix.runner == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: |
            .vcpkg_cache
            .vcpkg_downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Ensure vcpkg cache dirs (Windows)
        if: matrix.runner == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:VCPKG_DOWNLOADS" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null

      - name: Ensure CMake 3.31.10 (Windows)
        if: matrix.runner == 'windows-latest'
        shell: pwsh
        run: |
          $ver = "3.31.10"
          $zip = "$env:RUNNER_TEMP\cmake-$ver.zip"
          Invoke-WebRequest -Uri "https://cmake.org/files/v3.31/cmake-$ver-windows-x86_64.zip" -OutFile $zip
          Expand-Archive $zip -DestinationPath "$env:RUNNER_TEMP\cmake"
            $cmakeDir = Get-ChildItem "$env:RUNNER_TEMP\cmake" -Directory | Select-Object -First 1
            "$($cmakeDir.FullName)\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install build deps (Linux)
        if: matrix.runner == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libssl-dev pkg-config

      - name: Install build deps (macOS)
        if: startsWith(matrix.runner, 'macos-')
        run: |
          brew update
          brew install openssl@3

      - name: Install vcpkg (Windows)
        if: matrix.runner == 'windows-latest'
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics

      - name: Pre-fetch Ninja (Windows)
        if: matrix.runner == 'windows-latest'
        shell: pwsh
        run: |
          $destDir = "$env:VCPKG_DOWNLOADS"
          New-Item -ItemType Directory -Force -Path $destDir | Out-Null
          $target = Join-Path $destDir "ninja-win-1.13.1.zip"
          if (!(Test-Path $target)) {
            $url = "https://github.com/ninja-build/ninja/releases/download/v1.13.1/ninja-win.zip"
            for ($i = 0; $i -lt 3; $i++) {
              Write-Host "Attempting ninja download ($($i+1))/3"
              try {
                Invoke-WebRequest -Uri $url -OutFile $target -UseBasicParsing -MaximumRedirection 5
                break
              } catch {
                Write-Warning "Download attempt $($i+1) failed: $_"
                Start-Sleep -Seconds 5
              }
            }
            if (!(Test-Path $target)) {
              Write-Error "Failed to prefetch ninja"
              exit 1
            }
          }

      - name: Pre-fetch OpenSSL source (Windows)
        if: matrix.runner == 'windows-latest'
        shell: pwsh
        run: |
          $destDir = "$env:VCPKG_DOWNLOADS"
          New-Item -ItemType Directory -Force -Path $destDir | Out-Null
          $target = Join-Path $destDir "openssl-openssl-openssl-3.6.0.tar.gz"
          if (!(Test-Path $target)) {
            $urls = @(
              "https://www.openssl.org/source/openssl-3.6.0.tar.gz",
              "https://www.openssl.org/source/old/3.6/openssl-3.6.0.tar.gz"
            )
            foreach ($u in $urls) {
              Write-Host "Attempting download from $u"
              try {
                Invoke-WebRequest -Uri $u -OutFile $target -UseBasicParsing -MaximumRedirection 5
                break
              } catch {
                Write-Warning "Download failed from $u : $_"
              }
            }
            if (!(Test-Path $target)) {
              Write-Error "Failed to prefetch OpenSSL source"
              exit 1
            }
          }

      - name: Install OpenSSL (Windows)
        if: matrix.runner == 'windows-latest'
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" install openssl:x64-windows-static

      - name: Configure
        shell: bash
        run: |
          if [[ "${{ matrix.runner }}" == "windows-latest" ]]; then
            cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" \
              -DVCPKG_TARGET_TRIPLET=x64-windows-static \
              -DOPENSSL_USE_STATIC_LIBS=ON
          elif [[ "${{ matrix.runner }}" == macos-* ]]; then
            OPENSSL_ROOT=$(brew --prefix openssl@3)
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
              -DOPENSSL_ROOT_DIR="${OPENSSL_ROOT}" \
              -DOPENSSL_USE_STATIC_LIBS=ON
          else
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
              -DOPENSSL_USE_STATIC_LIBS=ON
          fi

      - name: Build
        shell: bash
        run: |
          if [[ "${{ matrix.runner }}" == "windows-latest" ]]; then
            cmake --build build --config Release
          else
            cmake --build build --parallel
          fi

      - name: Run tests
        shell: bash
        run: |
          if [[ "${{ matrix.runner }}" == "windows-latest" ]]; then
            ctest --test-dir build -C Release --output-on-failure
          else
            ctest --test-dir build --output-on-failure
          fi

      - name: Package
        shell: bash
        run: |
          cpack -G "${{ matrix.cpack_generator }}" -B dist --config build/CPackConfig.cmake
          shopt -s nullglob
          files=(dist/*.${{ matrix.artifact_ext }})
          if [[ ${#files[@]} -ne 1 ]]; then
            echo "Expected exactly one package, found ${#files[@]}." >&2
            exit 1
          fi
          dest="dist/bloch-${{ inputs.tag }}-${{ matrix.os_name }}-${{ matrix.arch }}.${{ matrix.artifact_ext }}"
          mv "${files[0]}" "$dest"
          if command -v python3 >/dev/null 2>&1; then
            PYTHON_BIN=python3
          elif command -v python >/dev/null 2>&1; then
            PYTHON_BIN=python
          else
            echo "Python is required to compute checksums" >&2
            exit 1
          fi
          PKG_PATH="$dest" "$PYTHON_BIN" - <<'PY' > "dist/checksums-${{ matrix.os_name }}-${{ matrix.arch }}.txt"
          import hashlib, pathlib, os
          path = pathlib.Path(os.environ["PKG_PATH"])
          digest = hashlib.sha256(path.read_bytes()).hexdigest()
          print(f"{digest}  {path.name}")
          PY
          ls -l dist

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloch-${{ inputs.tag }}-${{ matrix.os_name }}-${{ matrix.arch }}
          path: |
            dist/bloch-${{ inputs.tag }}-${{ matrix.os_name }}-${{ matrix.arch }}.${{ matrix.artifact_ext }}
            dist/checksums-${{ matrix.os_name }}-${{ matrix.arch }}.txt

  release:
    runs-on: ubuntu-latest
    needs: package
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bloch-${{ inputs.tag }}-*
          path: dist

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag }}
          name: Bloch ${{ inputs.tag }}
          draft: false
          prerelease: ${{ contains(inputs.tag, 'rc') }}
          files: dist/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
